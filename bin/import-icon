#!/usr/bin/env ruby

require 'net/http'
require 'uri'
require 'zip'
require 'fileutils'
require 'pathname'

class IconImporter
  LUCIDE_VERSION = '0.545.0'
  LUCIDE_URL = "https://github.com/lucide-icons/lucide/releases/download/#{LUCIDE_VERSION}/lucide-icons-#{LUCIDE_VERSION}.zip"
  TMP_DIR = File.join(__dir__, '..', 'tmp')
  VENDOR_DIR = File.join(__dir__, '..', 'vendor', 'assets', 'images')

  def initialize(icon_name)
    @icon_name = icon_name
    @tmp_extract_dir = File.join(TMP_DIR, "lucide-icons-#{LUCIDE_VERSION}")
    @vendor_icons_dir = File.join(VENDOR_DIR, "lucide-icons-#{LUCIDE_VERSION}")
  end

  def run
    puts "Importing icon: #{@icon_name}"

    ensure_tmp_extracted
    move_icon_to_vendor
    puts "‚úÖ Successfully imported #{@icon_name}.svg"
  end

  private

  def ensure_tmp_extracted
    # Check if the extraction directory exists and has SVG files
    if Dir.exist?(@tmp_extract_dir) && Dir.glob(File.join(@tmp_extract_dir, "*.svg")).any?
      puts "üìÅ Lucide icons already extracted in tmp/lucide-icons-#{LUCIDE_VERSION}/"
      return
    end

    puts "üì• Downloading Lucide icons v#{LUCIDE_VERSION}..."
    download_and_extract
  end

  def download_and_extract
    zip_path = File.join(TMP_DIR, "lucide-#{LUCIDE_VERSION}.zip")

    # Download the zip file
    download_file(LUCIDE_URL, zip_path)

    # Extract the zip file
    puts "üì¶ Extracting icons..."
    extract_zip(zip_path, TMP_DIR)

    # Clean up the zip file
    File.delete(zip_path) if File.exist?(zip_path)

    puts "‚úÖ Icons extracted to #{@tmp_extract_dir}"
  end

  def download_file(url, destination)
    uri = URI(url)

    Net::HTTP.start(uri.host, uri.port, use_ssl: uri.scheme == 'https') do |http|
      request = Net::HTTP::Get.new(uri)

      http.request(request) do |response|
        case response.code
        when '200'
          File.open(destination, 'wb') do |file|
            response.read_body do |chunk|
              file.write(chunk)
            end
          end
        when '302', '301'
          # Follow redirect
          redirect_url = response['location']
          puts "üîÑ Following redirect to: #{redirect_url}"
          download_file(redirect_url, destination)
        else
          raise "Failed to download: #{response.code} #{response.message}"
        end
      end
    end
  end

  def extract_zip(zip_path, extract_to)
    # Create the extraction directory
    FileUtils.mkdir_p(@tmp_extract_dir) unless Dir.exist?(@tmp_extract_dir)

    Zip::File.open(zip_path) do |zip_file|
      zip_file.each do |entry|
        # Extract only the icons directory and LICENSE
        if entry.name.include?('icons/') && (entry.name.end_with?('.svg') || entry.name.end_with?('LICENSE'))
          # Create the target path
          relative_path = entry.name.gsub(/^[^\/]+\//, '') # Remove the root directory name
          target_path = File.join(@tmp_extract_dir, File.dirname(relative_path))

          # Create directory if it doesn't exist
          FileUtils.mkdir_p(target_path) unless Dir.exist?(target_path)

          # Extract the file
          entry.extract(File.join(@tmp_extract_dir, relative_path)) { true } # Overwrite if exists
        end
      end
    end
  end

  def move_icon_to_vendor
    # Ensure vendor directory exists
    FileUtils.mkdir_p(@vendor_icons_dir) unless Dir.exist?(@vendor_icons_dir)

    # Find the icon in the extracted directory
    icon_path = find_icon_in_extracted

    if icon_path.nil?
      puts "‚ùå Icon '#{@icon_name}' not found in Lucide icons"
      puts "üí° Available icons:"
      list_available_icons
      exit 1
    end

    # Copy the icon to vendor directory
    target_path = File.join(@vendor_icons_dir, "#{@icon_name}.svg")
    FileUtils.cp(icon_path, target_path)

    # Also copy LICENSE if it doesn't exist
    license_source = File.join(@tmp_extract_dir, 'LICENSE')
    license_target = File.join(@vendor_icons_dir, 'LICENSE')
    FileUtils.cp(license_source, license_target) if File.exist?(license_source) && !File.exist?(license_target)
  end

  def find_icon_in_extracted
    # Look for the icon file directly in tmp directory
    icon_file = File.join(@tmp_extract_dir, "#{@icon_name}.svg")
    return icon_file if File.exist?(icon_file)

    # Try with kebab-case conversion
    kebab_name = @icon_name.gsub(/([A-Z])/, '-\1').downcase.gsub(/^-/, '')
    kebab_file = File.join(@tmp_extract_dir, "#{kebab_name}.svg")
    return kebab_file if File.exist?(kebab_file)

    nil
  end

  def list_available_icons
    icons = Dir.glob(File.join(@tmp_extract_dir, '*.svg')).map { |f| File.basename(f, '.svg') }
    icons.sort.each_slice(4) do |row|
      puts "   #{row.map { |icon| icon.ljust(20) }.join}"
    end
  end
end

# Main execution
if ARGV.empty?
  puts "Usage: #{$0} ICON_NAME"
  puts "Example: #{$0} chevron-down"
  exit 1
end

icon_name = ARGV[0]
importer = IconImporter.new(icon_name)
importer.run
